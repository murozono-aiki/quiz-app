<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>クイズ</title>
    <link rel="icon" href="./favicon.ico">
    <link rel="manifest" href="./manifest.json">
    <meta name="robots" content="noindex">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">

    <script>
      let url = "";
      try {
        url = localStorage.getItem("quiz-app-URL");
      } catch(error) {
        console.error(error);
      }
    </script>







    <style>
      html {
        color: #333333;
        font-family: "Noto Sans JP", sans-serif;
        font-optical-sizing: auto;
        font-weight: 400;
        font-style: normal;
        line-height: 1.4;
      }
      body {
        -webkit-user-select: none;
        user-select: none;
        background-color: white;
      }
      button , input {
        color: inherit;
        font-family: inherit;
        font-optical-sizing: inherit;
        font-weight: inherit;
        font-style: inherit;
      }
      input[type="checkbox"], input[type="radio"],  input[type="range"], progress {
        accent-color: #0075ff;
      }
      button {
        cursor: pointer;
      }
      dialog {
        border-radius: 7px;
        min-width: 40vw;
      }
      .form-submit {
        text-align: right;
      }

      #countdown {
        width: calc(100% - 7rem);
      }
      #countdown_label {
        display: inline-block;
        width: 4rem;
        margin-left: 1rem;
      }

      #main {
        overflow-y: auto;
        max-height: calc(90vh - 60px - 1rem - 0.6rem - 3rem - 30px);
      }
      
      #question {
        padding: 0 max(30px, 5%);
        margin-top: 0.3rem;
        margin-bottom: 0.3rem;
        white-space: pre-wrap;
        font-size: max(3vh, 1.15rem);
      }
      #question_not_read {
        color: #949494;
      }

      #answer {
        display: flex;
        flex-direction: column;
        align-items: center;
        align-content: flex-end;
        flex-wrap: wrap;

        position: sticky;
        bottom: 0;
        background-color: white;

        text-align: justify;
        padding: 0 max(30px, 5%);
        padding-left: calc(max(30px, 5%) + 1rem);
        white-space: pre-wrap;
        font-size: max(3vh, 1.15rem);
      }
      #answer1 {
        color: #e61283;
      }
      #answer2 {
        font-size: max(1.6vh, 0.6rem);
      }

      #questionLabel {
        color: #595959;
        text-align: right;
        font-size: 0.6rem;
        margin-right: 15px;
        margin-top: 10px;
      }

      #answer_button {
        min-width: 30%;
        height: 10vh;
        margin: 25px;
        font-size: 5vh;
        background-color: #a9ddf9;
        border-radius: 5px;
        border: none;
      }
      #answer_button:disabled {
        cursor: default;
      }
      #next_question {
        min-width: 50%;
        height: 10vh;
        margin: 25px;
        font-size: 5vh;
        background-color: #f9f7a9;
        border-radius: 5px;
        border: none;
      }
      #answer_button_space {
        position: fixed;
        bottom: 60px;
        right: 0;
        left: 0;
        text-align: center;
        z-index: 1;
      }

      #answer_input_cover {
        position: fixed;
        top: 0;
        right: 0;
        left: 0;
        bottom: 0;
        z-index: 2;
        background-color: #0000001a;
      }
      #answer_input_space {
        position: fixed;
        bottom: 75px;
        right: 20px;
        left: 20px;
        z-index: 2;
        background-color: white;
        box-shadow: lightgray 0 0 10px;
        padding: 10px;
        text-align: center;
        border-radius: 10px;
        margin-left: auto;
        max-width: 25rem/*33rem*/;
        display: grid;
      }
      #answer_input {
        height: 20vh;
        overflow-y: auto;
        overflow-x: hidden;
        text-align: left;
        padding: 0 15px;
        white-space: nowrap;
        font-size: 1.1rem;
      }
      #answer_input span {
        display: inline-block;
        height: 100%;
        vertical-align: middle;
      }
      #answer_input_write {
        display: inline-block;
        vertical-align: middle;
        white-space: pre-wrap;
      }
      .answer_input_buttons button {
        box-sizing: border-box;
        width: 20%;
        margin: 1.5%;
        max-height: 13vh;
        min-height: 9vh;
        height: calc(20vw - 12px);
        font-size: min(8vw, 6vh);
        background-color: inherit;
        border-radius: 5px;
        border: 1px solid #666666;
      }
      .answer_input_buttons {
        margin-bottom: 9px;
      }
      #inputCountdown {
        text-align: right;
        margin: 5px 20px;
      }

      #correct {
        display: inline-block;
        position: fixed;
        width: fit-content;
        height: fit-content;
        margin: auto;
        top: 0;
        right: 0;
        left: 0;
        bottom: 0;
        font-size: min(20vw, 7rem);
        color: red;
        z-index: 3;
      }
      #incorrect {
        display: inline-block;
        position: fixed;
        width: fit-content;
        height: fit-content;
        margin: auto;
        top: 0;
        right: 0;
        left: 0;
        bottom: 0;
        font-size: min(20vw, 7rem);
        color: blue;
        z-index: 3;
      }

      #loading {
        display: inline-block;
        color: #999999;
        margin-right: 5px;
        font-size: 0.8em;
      }

      #header {
        height: 2rem;
        margin-top: 0.1rem;
        margin-right: 7px;
        margin-bottom: 0.9rem;
        margin-left: 7px;

        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }
      #startProcess , #stopProcess {
        width: 5rem;
        height: 1.8rem;
        background-color: ghostwhite;
        border-radius: 3px;
        border: 1px solid #ccccff;
      }
      #openSetting {
        text-decoration: none;
        color: inherit;
        display: inline-block;
        width: 3rem;
        padding: 0.2rem 0;
        background-color: #f5e9ff;
        text-align: center;
        border-radius: 3px;
        border: 1px solid #deb3ff;
        font-size: 0.85rem;
      }
      #openSetting:hover {
        box-shadow: lightgray 0 0 7px;
      }
      #setting > * {
        margin-top: 15px;
        margin-bottom: 15px;
      }
      #closeSetting {
        text-decoration: none;
        color: inherit;
        display: inline-block;
        width: 3rem;
        padding: 0.2rem 0;
        background-color: #ffffff;
        text-align: center;
        border-radius: 3px;
        border: 1px solid #c5c5c5;
        font-size: 0.85rem;
      }
      #closeSetting:hover {
        box-shadow: lightgray 0 0 7px;
      }
      #questionSelect > div {
        margin-top: 4px;
      }
      #questionSelect > div > label {
        margin-right: 4px;
      }
      #makingQuestionLink {
        text-decoration: none;
        color: inherit;
        display: inline-block;
        width: 3rem;
        padding: 0.2rem 0;
        background-color: #f5e9ff;
        text-align: center;
        border-radius: 3px;
        border: 1px solid #deb3ff;
        font-size: 0.85rem;
      }
      #makingQuestionLink:hover {
        box-shadow: lightgray 0 0 7px;
      }

      @media (hover: hover) {
        .answer_input_buttons button:hover {
          background-color: ghostwhite;
        }
      }

      @media screen and (min-width: calc(25rem + 20px + 40px)) {
        .answer_input_buttons button {
          max-height: 10vh;
          font-size: min(6vw, 5vh);
        }
      }

      @media (orientation: landscape) {
        #answer_input {
          order: 1;
        }

        #answer_input_space {
          bottom: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div id="header">
      <div>
        <button id="stopProcess">一時停止</button>
        <button id="startProcess">再開</button>
      </div>
      <div>
        <div id="loading">通信中</div>
        <button id="openSetting">設定</button>
        <dialog id="setting">
          <button id="closeSetting" autofocus>閉じる</button>
          <div>
            <label>
              <input type="checkbox" id="reviewSetting" checked>
              間違えた問題を再度出題
            </label>
          </div>
          <div>
            <label>
              <input type="checkbox" id="useFullscreen" checked>
              全画面表示を使用
            </label>
          </div>
          <div>
            <label>
              <input type="checkbox" id="useSmartphoneMode">
              入力欄を小型化
            </label>
          </div>
          <div id="questionSelect"></div>
          <a href="" id="makingQuestionLink">作問</a>
        </dialog>
      </div>
    </div>
    <div id="answer_input_cover">
      <div id="answer_input_space">
        <div id="inputCountdown">4</div>
        <div id="answer_input">
          <span></span>
          <div id="answer_input_write">答え</div>
        </div>
        <div class="answer_input_buttons">
          <button id="button1">い</button>
          <button id="button2">ろ</button>
          <button id="button3">は</button>
          <button id="button4">に</button>
        </div>
        <div class="answer_input_buttons">
          <button id="button5">ほ</button>
          <button id="button6">て</button>
          <button id="button7">と</button>
          <button id="button8">ち</button>
        </div>
      </div>
    </div>
    <div id="correct">正解</div>
    <div id="incorrect">不正解</div>

    <div>
      <label for="countdown" id="countdown_label">9.00</label>
      <progress id="countdown" max="900" value="900"></progress>
    </div>
    <div id="main">
      <div id="question"><span id="question_read">読み込み中...</span><span id="question_not_read"></span></div>
      <div id="answer">
        <div id="answer1"></div>
        <div id="answer2"></div>
      </div>
      <div id="questionLabel"></div>
    </div>
    <div id="answer_button_space">
      <button id="answer_button">解答</button>
      <button id="next_question">次の問題</button>
    </div>

    <dialog id="firstDialog">
      <p id="firstDialogMessage">
        URLを入力してください。
      </p>
      <form method="dialog" id="firstForm">
        <label for="API-input">API URL</label><br>
        <input type="url" id="API-input">
        <div class="form-submit">
          <button type="submit">決定</button>
        </div>
      </form>
    </dialog>

    <script>
      let questionData;
      let sameChars;
      let notNextChars;

      const hiragana = [
        "あ", "い", "う", "え", "お",
        "か", "き", "く", "け", "こ",
        "が", "ぎ", "ぐ", "げ", "ご",
        "さ", "し", "す", "せ", "そ",
        "ざ", "じ", "ず", "ぜ", "ぞ",
        "た", "ち", "つ", "て", "と", "っ",
        "だ", "ぢ", "づ", "で", "ど",
        "な", "に", "ぬ", "ね", "の",
        "は", "ひ", "ふ", "へ", "ほ",
        "ば", "び", "ぶ", "べ", "ぼ",
        "ぱ", "ぴ", "ぷ", "ぺ", "ぽ",
        "ま", "み", "む", "め", "も",
        "や", "ゆ", "よ", "ゃ", "ゅ", "ょ",
        "ら", "り", "る", "れ", "ろ",
        "わ", "を", "ん"
      ];
      const katakana = [
        "ア", "イ", "ウ", "エ", "オ", "ヴ",
        "ァ", "ィ", "ゥ", "ェ", "ォ",
        "カ", "キ", "ク", "ケ", "コ",
        "ガ", "ギ", "グ", "ゲ", "ゴ",
        "サ", "シ", "ス", "セ", "ソ",
        "ザ", "ジ", "ズ", "ゼ", "ゾ",
        "タ", "チ", "ツ", "テ", "ト", "ッ",
        "ダ", "ヂ", "ヅ", "デ", "ド",
        "ナ", "ニ", "ヌ", "ネ", "ノ",
        "ハ", "ヒ", "フ", "ヘ", "ホ",
        "バ", "ビ", "ブ", "ベ", "ボ",
        "パ", "ピ", "プ", "ペ", "ポ",
        "マ", "ミ", "ム", "メ", "モ",
        "ヤ", "ユ", "ヨ", "ャ", "ュ", "ョ",
        "ラ", "リ", "ル", "レ", "ロ",
        "ワ", "ヲ", "ン", "ー"
      ];
      const alphabet_small = ["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"];
      const alphabet_large = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];
      const number = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "."];
      // 特殊
      const hiragana_old = [
        "あ", "う", "お",
        "か", "き", "く", "け", "こ",
        "が", "ぎ", "ぐ", "げ", "ご",
        "さ", "し", "す", "せ", "そ",
        "ざ", "じ", "ず", "ぜ", "ぞ",
        "た", "ち", "つ", "て", "と", "っ",
        "だ", "ぢ", "づ", "で", "ど",
        "な", "に", "ぬ", "ね", "の",
        "は", "ひ", "ふ", "へ", "ほ",
        "ば", "び", "ぶ", "べ", "ぼ",
        "ぱ", "ぴ", "ぷ", "ぺ", "ぽ",
        "ま", "み", "む", "め", "も",
        "や", "ゐ", "ゆ", "ゑ", "よ", "ゃ", "ゅ", "ょ",
        "ら", "り", "る", "れ", "ろ",
        "わ", "を", "ん"
      ];
      const katakana_old = [
        "ア", "ウ", "オ",
        "カ", "キ", "ク", "ケ", "コ",
        "ガ", "ギ", "グ", "ゲ", "ゴ",
        "サ", "シ", "ス", "セ", "ソ",
        "ザ", "ジ", "ズ", "ゼ", "ゾ",
        "タ", "チ", "ツ", "テ", "ト", "ッ",
        "ダ", "ヂ", "ヅ", "デ", "ド",
        "ナ", "ニ", "ヌ", "ネ", "ノ",
        "ハ", "ヒ", "フ", "ヘ", "ホ",
        "バ", "ビ", "ブ", "ベ", "ボ",
        "パ", "ピ", "プ", "ペ", "ポ",
        "マ", "ミ", "ム", "メ", "モ",
        "ヤ", "ヰ", "ユ", "ヱ", "ヨ", "ャ", "ュ", "ョ",
        "ラ", "リ", "ル", "レ", "ロ",
        "ワ", "ヲ", "ン"
      ];
      // 別の文字に変換する文字
      const convert = [
        ["あ", "ア"], ["い", "イ"], ["う", "ウ"], ["え", "エ"], ["お", "オ"],
        ["か", "カ"], ["き", "キ"], ["く", "ク"], ["け", "ケ"], ["こ", "コ"],
        ["が", "ガ"], ["ぎ", "ギ"], ["ぐ", "グ"], ["げ", "ゲ"], ["ご", "ゴ"],
        ["さ", "サ"], ["し", "シ"], ["す", "ス"], ["せ", "セ"], ["そ", "ソ"],
        ["ざ", "ザ"], ["じ", "ジ"], ["ず", "ズ"], ["ぜ", "ゼ"], ["ぞ", "ゾ"],
        ["た", "タ"], ["ち", "チ"], ["つ", "ツ"], ["て", "テ"], ["と", "ト"], ["っ", "ッ"],
        ["だ", "ダ"], ["ぢ", "ヂ"], ["づ", "ヅ"], ["で", "デ"], ["ど", "ド"],
        ["な", "ナ"], ["に", "ニ"], ["ぬ", "ヌ"], ["ね", "ネ"], ["の", "ノ"],
        ["は", "ハ"], ["ひ", "ヒ"], ["ふ", "フ"], ["へ", "ヘ"], ["ほ", "ホ"],
        ["ば", "バ"], ["び", "ビ"], ["ぶ", "ブ"], ["べ", "ベ"], ["ぼ", "ボ"],
        ["ぱ", "パ"], ["ぴ", "ピ"], ["ぷ", "プ"], ["ぺ", "ペ"], ["ぽ", "ポ"],
        ["ま", "マ"], ["み", "ミ"], ["む", "ム"], ["め", "メ"], ["も", "モ"],
        ["や", "ヤ"], ["ゐ", "ヰ"], ["ゆ", "ユ"], ["ゑ", "ヱ"], ["よ", "ヨ"], ["ゃ", "ャ"], ["ゅ", "ュ"], ["ょ", "ョ"],
        ["ら", "ラ"], ["り", "リ"], ["る", "ル"], ["れ", "レ"], ["ろ", "ロ"],
        ["わ", "ワ"], ["を", "ヲ"], ["ん", "ン"]
      ]
      // 前の文字を参考にする文字
      const symbols = ["ー", "-", "＝", "=", "・"];

          
      /** @type {HTMLDivElement} */
      const questionElement = document.getElementById("question");  // 問題を表示する要素
      /** @type {HTMLSpanElement} */
      const questionReadElement = document.getElementById("question_read");  // 問題を表示する要素
      /** @type {HTMLSpanElement} */
      const questionNotReadElement = document.getElementById("question_not_read");  // 問題を表示する要素
      /** @type {HTMLDivElement} */
      const answer1Element = document.getElementById("answer1");  // 解答を表示する要素
      /** @type {HTMLDivElement} */
      const answer2Element = document.getElementById("answer2");  // 解答（答えるとき）を表示する要素
      /** @type {HTMLDivElement} */
      const questionLabelElement = document.getElementById("questionLabel");  // 問題のラベルを表示する要素
      /** @type {HTMLProgressElement} */
      const countdownElement = document.getElementById("countdown");  // プログレスバー
      /** @type {HTMLLabelElement} */
      const countdownLabelElement = document.getElementById("countdown_label");  // プログレスバーの横の数字を表示する要素
      /** @type {HTMLButtonElement} */
      const answerButton = document.getElementById("answer_button");  // 解答の入力を開始するボタン
      /** @type {HTMLDivElement} */
      const answerInputElement = document.getElementById("answer_input_cover");  // 解答入力欄
      /** @type {HTMLDivElement} */
      const answerInputShowElement = document.getElementById("answer_input_write");  // 入力された解答を表示する要素
      /** @type {HTMLButtonElement} */
      const answerInputButton1 = document.getElementById("button1");  // 解答を入力するボタン1
      /** @type {HTMLButtonElement} */
      const answerInputButton2 = document.getElementById("button2");  // 解答を入力するボタン2
      /** @type {HTMLButtonElement} */
      const answerInputButton3 = document.getElementById("button3");  // 解答を入力するボタン3
      /** @type {HTMLButtonElement} */
      const answerInputButton4 = document.getElementById("button4");  // 解答を入力するボタン4
      /** @type {HTMLButtonElement} */
      const answerInputButton5 = document.getElementById("button5");  // 解答を入力するボタン5
      /** @type {HTMLButtonElement} */
      const answerInputButton6 = document.getElementById("button6");  // 解答を入力するボタン6
      /** @type {HTMLButtonElement} */
      const answerInputButton7 = document.getElementById("button7");  // 解答を入力するボタン7
      /** @type {HTMLButtonElement} */
      const answerInputButton8 = document.getElementById("button8");  // 解答を入力するボタン8
      /** @type {HTMLDivElement} */
      const inputCountdownElement = document.getElementById("inputCountdown");  // 解答入力の際のカウントダウン
      /** @type {HTMLDivElement} */
      const correctElement = document.getElementById("correct");  // 正解のときの要素
      /** @type {HTMLDivElement} */
      const incorrectElement = document.getElementById("incorrect");  // 不正解のときの要素
      /** @type {HTMLButtonElement} */
      const nextQuestionButton = document.getElementById("next_question");  // 次の問題を出題するボタン
      /** @type {HTMLButtonElement} */
      const stopElement = document.getElementById("stopProcess");  // 一時停止ボタン
      /** @type {HTMLButtonElement} */
      const startElement = document.getElementById("startProcess");  // 再開ボタン
      /** @type {HTMLButtonElement} */
      const settingButton = document.getElementById("openSetting");  // 設定表示ボタン
      /** @type {HTMLDialogElement} */
      const settingDialog = document.getElementById("setting");  // 設定のダイアログ
      /** @type {HTMLButtonElement} */
      const settingCloseButton = document.getElementById("closeSetting");  // 設定非表示ボタン
      /** @type {HTMLInputElement} */
      const reviewSettingCheckbox = document.getElementById("reviewSetting");  // 復習設定
      /** @type {HTMLDivElement} */
      const questionSelectElement = document.getElementById("questionSelect");  // 問題選択要素
      let nowQuestion;  // 現在の問題（配列）
      let nowShowWordCount = 0;  // 現在の問題の表示文字数
      let questionTextNodes = [];
      let countdown = 900;  // カウントダウンの秒数(100が1秒)
      let intervalId;  // インターバルのid
      let inputCountdown = 500;  // 解答入力のカウントダウンの秒数(100が1秒)
      let inputIntervalId;  // 解答入力のインターバルのid
      let continueProcess = true;  // カウントダウンを継続するか
      let is_active = false; // 一時停止されていないか
      let inputAnswer = "";  // 入力された解答
      let inputAnswerCount = 0;  // 入力された解答の文字数
      let inputtingAnswer = false;  // 解答の入力受付中かどうか
      let answerButtonIndex = [0, 1, 2, 3];  // ボタンと選択肢の対応
      let answerChoise = [];  // 解答の選択肢
      let nowQuestionIndex;  // 現在の問題のインデックス
      let lastQuestionIndex = [];  // 前回の問題のインデックス
      let record = [];  // 正答数、出題数の記録
      let recordLength = 0;  // 記録の数
      let record_session = [];  // 現在のセッションにおける正答数、出題数、前回出されてからの他の問題の出題数の記録
      let is_review = false;  // 間違えた問題の再出題かどうか
      /**
       * @type {Object.<string, {is_question:boolean, range:boolean, range_min:number, range_max:number}>}
      */
      let questionSelect = {};

      function main() {

        function getQuestionIndex() {
          if (reviewSettingCheckbox.checked) {
            const indexArray = [];
            for (let i = 0; i < record_session.length; i++) {
              if (!record_session[i]) continue;
              const index = i;

              const questionLabel = questionData[index][5].split(" #");
              const questionName = questionLabel[0];
              const questionNumber = parseInt(questionLabel[1]);
              if (!questionSelect[questionName].is_question) continue;
              if (questionSelect[questionName].range) {
                if (questionNumber < questionSelect[questionName].range_min || questionSelect[questionName].range_max < questionNumber) {
                  continue;
                }
              }

              indexArray.push(index);
            }
            if (indexArray.length > 10 || !is_review/* 前回の問題が復習でなかったとき */) {
              while (indexArray.length > 0) {
                const arrayIndex = Math.floor(Math.random() * indexArray.length);
                const index = indexArray[arrayIndex];

                const rate_session = record_session[index][0] / record_session[index][1];
                if ((rate_session <= 0.5 || record_session[index][1] < 4) && record_session[index][1] < 17) {
                  if (record_session[index][2] >=  (rate_session * 8) + 4) {
                    is_review = true;
                    return index;
                  }
                } else {
                  record_session[index] = undefined;
                }

                indexArray.splice(arrayIndex, 1);
              }
            }
          }


          let questionIndexList = [];

          let average = 0;
          for (let i = 0; i < questionData.length; i++) {
            average += questionData[i][7] || 0;
          }
          average = average / questionData.length;

          for (let i = 0; i < questionData.length; i++) {
            if (questionData.length > lastQuestionIndex.length && lastQuestionIndex.includes(i)) continue;  // 直近に出した問題は出題しない
            const questionLabel = questionData[i][5].split(" #");
            const questionName = questionLabel[0];
            const questionNumber = parseInt(questionLabel[1]);
            if (!questionSelect[questionName].is_question) continue;
            if (questionSelect[questionName].range) {
              if (questionNumber < questionSelect[questionName].range_min || questionSelect[questionName].range_max < questionNumber) {
                continue;
              }
            }

            questionIndexList.push(i);
            let loopIndex_average = (average - questionData[i][7]) * 8/*問題の出やすさ*/;
            for (let j = 0; j < loopIndex_average; j++) {
              questionIndexList.push(i);
            }


            const correct = questionData[i][6] || 0;
            const total = questionData[i][7] || 0;

            const rate = (correct + 2) / (total + 3);

            let loopIndex_rate = Math.floor(((1 / rate) - 1) * 0.5/*問題の出やすさ*/);
            for (let j = 0; j < loopIndex_rate; j++) {
              questionIndexList.push(i);
            }
          }
          is_review = false;
          return questionIndexList[Math.floor(Math.random() * questionIndexList.length)];
        }

        function getChoice(questionData) {
          const numberOfChoice = 8;

          let correctAnswer = questionData[2];
          let includeAnswers = questionData[3].split("/");
          let notIncludeAnswers = questionData[4].split("/");

          // 正答を変換
          for (let convertString of convert) {
            correctAnswer = correctAnswer.replaceAll(convertString[0], convertString[1]);
            for (let i = 0; i < includeAnswers.length; i++) {
              includeAnswers[i] = includeAnswers[i].replaceAll(convertString[0], convertString[1]);
            }
            for (let i = 0; i < notIncludeAnswers.length; i++) {
              notIncludeAnswers[i] = notIncludeAnswers[i].replaceAll(convertString[0], convertString[1]);
            }
          }

          let result = [];
          for (let i = 0; i < correctAnswer.length; i++) {
            let correctChar = correctAnswer.slice(i, i + 1);
            let includeChars = [];
            let notIncludeChars = [];
            let choice = [correctChar];

            for (let includeAnswer of includeAnswers) {
              const char = includeAnswer.slice(i, i + 1);
              if (char != correctChar && !includeAnswers.includes(char) && char) includeChars.push(char);
            }
            for (let notIncludeAnswer of notIncludeAnswers) {
              const char = notIncludeAnswer.slice(i, i + 1);
              if (char != correctChar && !notIncludeChars.includes(char) && char) notIncludeChars.push(char);
            }

            while (choice.length < numberOfChoice) {
              if (includeChars.length == 0) break;
              const char = includeChars.splice(Math.floor(Math.random() * includeChars.length), 1)[0];
              if (!choice.includes(char) && !notIncludeChars.includes(char)) {
                choice.push(char);
              }
            }

            if (choice.length < numberOfChoice) {
              let chooseChars = [];
              for (let char of choice) {
                if (symbols.includes(char)) char = result[i - 1][0];

                if (hiragana.includes(char))  chooseChars = chooseChars.concat(hiragana);
                if (katakana.includes(char))  chooseChars = chooseChars.concat(katakana);
                if (alphabet_small.includes(char))  chooseChars = chooseChars.concat(alphabet_small);
                if (alphabet_large.includes(char))  chooseChars = chooseChars.concat(alphabet_large);
                if (number.includes(char))  chooseChars = chooseChars.concat(number);
                // 特殊
                if (chooseChars.length == 0) {
                  if (hiragana_old.includes(char))  chooseChars = chooseChars.concat(hiragana_old);
                  else if (katakana_old.includes(char))  chooseChars = chooseChars.concat(katakana_old);
                }
              }
              if (chooseChars.length == 0) {
                chooseChars = chooseChars.concat(hiragana);
                chooseChars = chooseChars.concat(katakana);
                chooseChars = chooseChars.concat(alphabet_small);
                chooseChars = chooseChars.concat(alphabet_large);
                chooseChars = chooseChars.concat(number);
              }

              notIncludeChars = notIncludeChars.concat(choice);
              for (let char of choice) {
                for (let sameChar of sameChars) {
                  if (sameChar[0].includes(char)) {
                    notIncludeChars = notIncludeChars.concat(sameChar[0].split(""));
                  }
                }
              }
              if (i > 0) {
                for (let notNextChar of notNextChars) {
                  if (notNextChar[0] == result[i - 1][0]) {
                    notIncludeChars = notIncludeChars.concat(notNextChar[1].split(""));
                  }
                }
              } else {
                for (let notNextChar of notNextChars) {
                  if (notNextChar[0] == "（始め）") {
                    notIncludeChars = notIncludeChars.concat(notNextChar[1].split(""));
                  }
                }
              }

              chooseChars = chooseChars.filter(item => !notIncludeChars.includes(item));

              while (choice.length < numberOfChoice) {
                const char = chooseChars[Math.floor(Math.random() * chooseChars.length)];
                chooseChars = chooseChars.filter(item => char != item);
                for (let sameChar of sameChars) {
                  if (sameChar[0].includes(char)) {
                    chooseChars = chooseChars.filter(item => !sameChar[0].includes(item));
                  }
                }
                choice.push(char);
              }
            }

            for (let j = 0; j < includeAnswers.length; j++) {
              if (includeAnswers[j].slice(i, i + 1) != correctChar) {
                includeAnswers.splice(j, 1);
                j--;
              }
            }
            for (let j = 0; j < notIncludeAnswers.length; j++) {
              if (notIncludeAnswers[j].slice(i, i + 1) != correctChar) {
                notIncludeAnswers.splice(j, 1);
                j--;
              }
            }
            result.push(choice);
          }
          return result;
        }



        requestAnimationFrame(() => {
          // 初期値へ
          //questionElement.innerHTML = "";
          questionReadElement.textContent = "";
          questionNotReadElement.textContent = "";
          answer1Element.textContent = "";
          answer2Element.textContent = "";
          questionLabelElement.textContent = "";
          nowShowWordCount = 0;
          questionTextNodes = [];
          countdown = 900;
          countdownElement.value = "900";
          countdownLabelElement.textContent = "9.00";
          inputCountdown = 500;
          inputCountdownElement.textContent = "5";
          inputCountdownElement.style.color = "green";
          nowQuestionIndex = getQuestionIndex();
          nowQuestion = questionData[nowQuestionIndex];
          inputAnswer = "";
          inputAnswerCount = 0;
          answerChoise = getChoice(nowQuestion);
          answerInputElement.style.display = "none";
          answerInputShowElement.textContent = "";
          answerButton.style.display = "";
          nextQuestionButton.style.display = "none";

          lastQuestionIndex.push(nowQuestionIndex);
          if (lastQuestionIndex.length > 20) lastQuestionIndex.shift();

          document.getElementById("makingQuestionLink").href = url + "?page=makingQuestion&questionIndex=" + questionData[nowQuestionIndex][8];

          answerButton.disabled = true;
          setTimeout(() => answerButton.disabled = false, 1000);

          
          for (let i = 0; i < nowQuestion[0].length; i++) {
            questionTextNodes[i] = document.createTextNode(nowQuestion[0][i]);
            questionNotReadElement.appendChild(questionTextNodes[i]);
          }

          let requestID = 0;
          intervalId = setInterval(() => {
            if (continueProcess && document.visibilityState == "visible") {
              if (nowShowWordCount < nowQuestion[0].length) {
                //const text = nowQuestion[0].slice(0, ++nowShowWordCount);
                //requestAnimationFrame(() => questionElement.textContent = text);
                requestAnimationFrame(() => questionReadElement.appendChild(questionTextNodes[nowShowWordCount++]));
              } else {
                clearInterval(intervalId);  // 問題の表示終了

                intervalId = setInterval(() => {
                  if (continueProcess && document.visibilityState == "visible") {
                    countdown--;
                    if (countdown >= 0) {
                      requestID = requestAnimationFrame(() => {
                        cancelAnimationFrame(requestID);
                        const countdownString = countdown.toString();
                        countdownElement.value = countdownString;
                        const countdownLabelString = "0".repeat(3 - countdownString.length) + countdownString;
                        countdown_label.textContent = countdownLabelString.slice(0, 1) + "." + countdownLabelString.slice(1, 3);
                      });
                    } else {
                      countdown = 0;
                      // 不正解
                      clearInterval(intervalId);
                      //onIncorrect();
                    }
                  }
                }, 10);
              }
            }
          }, 170);
        });
      }

      function main_event(event) {
        event.target.removeEventListener('click', main_event);
        if (!is_active) startElement.dispatchEvent(new Event('click'));
        main();
      }

      function setRecord(questionIndex_onData, correct) {
        const questionIndex = questionData[questionIndex_onData][8];

        if (!is_review) {
          if (!record[questionIndex]) record[questionIndex] = [0, 0];
          record[questionIndex][1] += 1;
          if (correct) record[questionIndex][0] += 1;
          recordLength++;
        }

        if (is_review || !correct) {
          if (!record_session[questionIndex_onData]) record_session[questionIndex_onData] = [0, 0, 0];
          record_session[questionIndex_onData][1] += 1;
          if (correct) record_session[questionIndex_onData][0] += 1;
          record_session[questionIndex_onData][2] = 0;
        }
        for (let i = 0; i < record_session.length; i++) {
          if (record_session[i]) record_session[i][2]++;
        }

        if (!is_review) {
          if (!questionData[questionIndex_onData][6]) questionData[questionIndex_onData][6] = 0;
          if (!questionData[questionIndex_onData][7]) questionData[questionIndex_onData][7] = 0;
          questionData[questionIndex_onData][7] += 1;
          if (correct) questionData[questionIndex_onData][6] += 1;
        }

        localStorage.setItem("record_session", JSON.stringify(record_session));
        localStorage.setItem("record", JSON.stringify(record));
      }

      function getRandomAnswerButtonIndex() {
        let result = [];
        let array = [0, 1, 2, 3, 4, 5, 6, 7];
        while (array.length > 0) {
          result.push(array.splice(Math.floor(Math.random() * array.length), 1)[0]);
        }
        if (inputAnswerCount >= 1) {
          for (let i = 0; i < result.length; i++) {
            if (answerChoise[inputAnswerCount][result[i]] == answerChoise[inputAnswerCount - 1][answerButtonIndex[i]] || (result[i] == 0 && answerButtonIndex[i] == 0)) {
              const indexCoice = [];
              for (let index of result) {
                if ((answerChoise[inputAnswerCount][result[i]] != answerChoise[inputAnswerCount - 1][answerButtonIndex[index]] && answerChoise[inputAnswerCount][result[index]] != answerChoise[inputAnswerCount - 1][answerButtonIndex[i]]) && (result[i] != 0 || answerButtonIndex[index] != 0)) {
                  indexCoice.push(index);
                }
              }
              let replaceIndex = indexCoice[Math.floor(Math.random() * indexCoice.length)];
              if (replaceIndex >= result.length) replaceIndex = 0;

              let temp = result[replaceIndex];
              result[replaceIndex] = result[i];
              result[i] = temp;
            }
          }
        }
        return result;
      }
      function settingAnswerInputButton() {
        inputtingAnswer = true;
        answerButtonIndex = getRandomAnswerButtonIndex();
        requestAnimationFrame(() => {
          answerInputButton1.textContent = answerChoise[inputAnswerCount][answerButtonIndex[0]];
          answerInputButton2.textContent = answerChoise[inputAnswerCount][answerButtonIndex[1]];
          answerInputButton3.textContent = answerChoise[inputAnswerCount][answerButtonIndex[2]];
          answerInputButton4.textContent = answerChoise[inputAnswerCount][answerButtonIndex[3]];
          answerInputButton5.textContent = answerChoise[inputAnswerCount][answerButtonIndex[4]];
          answerInputButton6.textContent = answerChoise[inputAnswerCount][answerButtonIndex[5]];
          answerInputButton7.textContent = answerChoise[inputAnswerCount][answerButtonIndex[6]];
          answerInputButton8.textContent = answerChoise[inputAnswerCount][answerButtonIndex[7]];
        });

        answerInputButton1.disabled = true;
        answerInputButton2.disabled = true;
        answerInputButton3.disabled = true;
        answerInputButton4.disabled = true;
        answerInputButton5.disabled = true;
        answerInputButton6.disabled = true;
        answerInputButton7.disabled = true;
        answerInputButton8.disabled = true;

        setTimeout(() => {
          answerInputButton1.disabled = false;
          answerInputButton2.disabled = false;
          answerInputButton3.disabled = false;
          answerInputButton4.disabled = false;
          answerInputButton5.disabled = false;
          answerInputButton6.disabled = false;
          answerInputButton7.disabled = false;
          answerInputButton8.disabled = false;
        }, 300);

        inputCountdown = 500;
        inputCountdownElement.textContent = "5";
        inputIntervalId = setInterval(() => {
          inputCountdown--;
          inputCountdownElement.textContent = Math.ceil(inputCountdown / 100).toString();
          if (inputCountdown > 400) {
            inputCountdownElement.style.color = "purple";
          } else if (inputCountdown > 300) {
            inputCountdownElement.style.color = "green";
          } else if (inputCountdown > 200) {
            inputCountdownElement.style.color = "blue";
          } else if (inputCountdown > 100) {
            inputCountdownElement.style.color = "orange";
          } else {
            inputCountdownElement.style.color = "red";
          }

          if (inputCountdown <= 0) {
            // 不正解
            clearInterval(inputIntervalId);
            //onIncorrect();
          }
        }, 10)
      }
      function onAnswerButtonClick() {
        if (continueProcess && inputAnswerCount < answerChoise.length) {
          continueProcess = false;
          answerInputElement.style.display = "";
          settingAnswerInputButton();
        }
      }
      function onAnswerInputButtonClick(button) {
        clearInterval(inputIntervalId);

        const answerIndex = answerButtonIndex[button];
        inputAnswer += answerChoise[inputAnswerCount][answerIndex];
        answerInputShowElement.textContent = inputAnswer;
        inputAnswerCount++;

        if (answerIndex != 0) {
          // 不正解
          onIncorrect();
        } else if (inputAnswerCount >= answerChoise.length) {
          // 正解
          onCorrect();
        } else {
          settingAnswerInputButton();
        }
      }
      answerButton.addEventListener('click', onAnswerButtonClick);
      answerInputButton1.addEventListener('click', event => onAnswerInputButtonClick(0));
      answerInputButton2.addEventListener('click', event => onAnswerInputButtonClick(1));
      answerInputButton3.addEventListener('click', event => onAnswerInputButtonClick(2));
      answerInputButton4.addEventListener('click', event => onAnswerInputButtonClick(3));
      answerInputButton5.addEventListener('click', event => onAnswerInputButtonClick(4));
      answerInputButton6.addEventListener('click', event => onAnswerInputButtonClick(5));
      answerInputButton7.addEventListener('click', event => onAnswerInputButtonClick(6));
      answerInputButton8.addEventListener('click', event => onAnswerInputButtonClick(7));
      document.addEventListener('keyup', event => {
        const key = event.key;
        if (!inputtingAnswer && key == " ") {
          onAnswerButtonClick();
        } else if (inputtingAnswer) {
          if (key == "1" || key == "f") {
            onAnswerInputButtonClick(0);
          }
          if (key == "2" || key == "g") {
            onAnswerInputButtonClick(1);
          }
          if (key == "3" || key == "h") {
            onAnswerInputButtonClick(2);
          }
          if (key == "4" || key == "j") {
            onAnswerInputButtonClick(3);
          }
          if (key == "5" || key == "v") {
            onAnswerInputButtonClick(4);
          }
          if (key == "6" || key == "b") {
            onAnswerInputButtonClick(5);
          }
          if (key == "7" || key == "n") {
            onAnswerInputButtonClick(6);
          }
          if (key == "8" || key == "m") {
            onAnswerInputButtonClick(7);
          }
        }
      });

      function onCorrect() {
        inputtingAnswer = false;
        clearInterval(intervalId);
        continueProcess = true;

        button1.disabled = true;
        button2.disabled = true;
        button3.disabled = true;
        button4.disabled = true;
        button5.disabled = true;
        button6.disabled = true;
        button7.disabled = true;
        button8.disabled = true;

        requestAnimationFrame(() => {
          correctElement.style.display = "";
        });
        localStorage.setItem("last_question", nowQuestionIndex.toString());
        setRecord(nowQuestionIndex, true);

        setTimeout(() => {
          requestAnimationFrame(() => {
            correctElement.style.display = "none";
            answerInputElement.style.display = "none";
          });
          button1.disabled = false;
          button2.disabled = false;
          button3.disabled = false;
          button4.disabled = false;
          button5.disabled = false;
          button6.disabled = false;
          button7.disabled = false;
          button8.disabled = false;

          intervalId = setInterval(() => {
            if (nowShowWordCount < nowQuestion[0].length) {
              //const text = nowQuestion[0].slice(0, ++nowShowWordCount);
              //questionElement.textContent = text;
              requestAnimationFrame(() => {
                questionReadElement.appendChild(questionTextNodes[nowShowWordCount++]);
                if (questionTextNodes[nowShowWordCount + 1]) questionReadElement.appendChild(questionTextNodes[nowShowWordCount++]);
                if (questionTextNodes[nowShowWordCount + 1]) questionReadElement.appendChild(questionTextNodes[nowShowWordCount++]);
              });
            } else {
              clearInterval(intervalId);  // 問題の表示終了

              setTimeout(() => {
                requestAnimationFrame(() => {
                  answer1Element.textContent = nowQuestion[1];
                  answer2Element.textContent = nowQuestion[2];
                  questionLabelElement.textContent = nowQuestion[5];

                  answerButton.style.display = "none";
                  nextQuestionButton.style.display = "";
                  nextQuestionButton.addEventListener('click', main_event);
                });
              }, 300);
            }
          }, 20/*50*/);
        }, 2000);

        if (!is_loading && recordLength >= 7) {
          requestSetRecord(record, data => {
            record = [];
            recordLength = 0;
            questionData = data;
            setQuestionSelect();
          });
        }
      }
      function onIncorrect() {
        inputtingAnswer = false;
        clearInterval(inputIntervalId);
        clearInterval(intervalId);
        continueProcess = true;
        inputAnswerCount = answerChoise.length;

        button1.disabled = true;
        button2.disabled = true;
        button3.disabled = true;
        button4.disabled = true;
        button5.disabled = true;
        button6.disabled = true;
        button7.disabled = true;
        button8.disabled = true;

        requestAnimationFrame(() => {
          incorrectElement.style.display = "";
        });
        localStorage.setItem("last_question", nowQuestionIndex.toString());
        setRecord(nowQuestionIndex, false);

        setTimeout(() => {
          requestAnimationFrame(() => {
            incorrectElement.style.display = "none";
            answerInputElement.style.display = "none";
          });
          button1.disabled = false;
          button2.disabled = false;
          button3.disabled = false;
          button4.disabled = false;
          button5.disabled = false;
          button6.disabled = false;
          button7.disabled = false;
          button8.disabled = false;

          intervalId = setInterval(() => {
            if (nowShowWordCount < nowQuestion[0].length) {
              //const text = nowQuestion[0].slice(0, ++nowShowWordCount);
              //questionElement.textContent = text;
              requestAnimationFrame(() => {
                questionReadElement.appendChild(questionTextNodes[nowShowWordCount++]);
                if (questionTextNodes[nowShowWordCount + 1]) questionReadElement.appendChild(questionTextNodes[nowShowWordCount++]);
                if (questionTextNodes[nowShowWordCount + 1]) questionReadElement.appendChild(questionTextNodes[nowShowWordCount++]);
              });
            } else {
              clearInterval(intervalId);  // 問題の表示終了

              setTimeout(() => {
                requestAnimationFrame(() => {
                  answer1Element.textContent = nowQuestion[1];
                  answer2Element.textContent = nowQuestion[2];
                  questionLabelElement.textContent = nowQuestion[5];

                  answerButton.style.display = "none";
                  nextQuestionButton.style.display = "";
                  nextQuestionButton.addEventListener('click', main_event);
                });
              }, 300);
            }
          }, 20/*50*/);
        }, 2000);

        if (!is_loading && recordLength >= 4) {
          requestSetRecord(record, data => {
            record = [];
            recordLength = 0;
            questionData = data;
            setQuestionSelect();
          });
        }
      }

      function setQuestionSelect() {
        /** @type {Object.<string, {min:number, max:number}>} */
        let questionLabelData = {};
        /** @type {string[]} */
        let questionNames = [];
        for (let question of questionData) {
          const label = question[5].split(" #");
          const questionName = label[0];
          const questionNumber = parseInt(label[1]);
          if (!questionLabelData[questionName]) {
            questionLabelData[questionName] = {min: Infinity, max: -Infinity};
            questionNames.push(questionName);
          }
          if (!questionSelect[questionName]) {
            questionSelect[questionName] = {is_question: true, range: false, range_min: -Infinity, range_max: Infinity};
          }
          if (questionLabelData[questionName].min > questionNumber) {
            questionLabelData[questionName].min = questionNumber;
          }
          if (questionLabelData[questionName].max < questionNumber) {
            questionLabelData[questionName].max = questionNumber;
          }
        }
        const collator = new Intl.Collator("ja");
        questionNames.sort(collator.compare);

        while (questionSelectElement.firstChild) {
          questionSelectElement.removeChild(questionSelectElement.firstChild);
        }
        for (let i = 0; i < questionNames.length; i++) {
          const questionName = questionNames[i];
          const questionLabel = questionLabelData[questionName];
          const questionSelectContainer = document.createElement("div");
          questionSelectElement.appendChild(questionSelectContainer);
          const questionSelectLabel = document.createElement("label");
          questionSelectContainer.appendChild(questionSelectLabel);
          const questionSelectInput = document.createElement("input");
          questionSelectLabel.appendChild(questionSelectInput);
          questionSelectInput.type = "checkbox";
          questionSelectInput.checked = questionSelect[questionName].is_question;
          questionSelectLabel.appendChild(document.createTextNode(questionName));
          const questionRangeMinElement = document.createElement("input");
          questionSelectContainer.appendChild(questionRangeMinElement);
          questionRangeMinElement.type = "text";
          questionRangeMinElement.inputMode = "numeric";
          questionRangeMinElement.min = questionLabel.min;
          questionRangeMinElement.max = questionLabel.max;
          questionRangeMinElement.style.width = "3rem";
          if (questionSelect[questionName].range_min != -Infinity) {
            questionRangeMinElement.value = questionSelect[questionName].range_min;
          }
          questionSelectContainer.appendChild(document.createTextNode("～"));
          const questionRangeMaxElement = document.createElement("input");
          questionSelectContainer.appendChild(questionRangeMaxElement);
          questionRangeMaxElement.type = "text";
          questionRangeMaxElement.inputMode = "numeric";
          questionRangeMaxElement.min = questionLabel.min;
          questionRangeMaxElement.max = questionLabel.max;
          questionRangeMaxElement.style.width = "3rem";
          if (questionSelect[questionName].range_max != Infinity) {
            questionRangeMaxElement.value = questionSelect[questionName].range_max;
          }

          questionSelectInput.addEventListener("change", event => {
            questionSelect[questionName].is_question = questionSelectInput.checked;
          });
          questionRangeMinElement.addEventListener("change", event => {
            let value = questionRangeMinElement.value;
            value = value.replaceAll("０", "0");
            value = value.replaceAll("１", "1");
            value = value.replaceAll("２", "2");
            value = value.replaceAll("３", "3");
            value = value.replaceAll("４", "4");
            value = value.replaceAll("５", "5");
            value = value.replaceAll("６", "6");
            value = value.replaceAll("７", "7");
            value = value.replaceAll("８", "8");
            value = value.replaceAll("９", "9");
            questionRangeMinElement.value = value;
            if (value !== "") {
              questionSelect[questionName].range = true;
              questionSelect[questionName].range_min = parseInt(value);
            } else {
              questionSelect[questionName].range_min = -Infinity;
            }
          });
          questionRangeMaxElement.addEventListener("change", event => {
            let value = questionRangeMaxElement.value;
            value = value.replaceAll("０", "0");
            value = value.replaceAll("１", "1");
            value = value.replaceAll("２", "2");
            value = value.replaceAll("３", "3");
            value = value.replaceAll("４", "4");
            value = value.replaceAll("５", "5");
            value = value.replaceAll("６", "6");
            value = value.replaceAll("７", "7");
            value = value.replaceAll("８", "8");
            value = value.replaceAll("９", "9");
            questionRangeMaxElement.value = value;
            if (value !== "") {
              questionSelect[questionName].range = true;
              questionSelect[questionName].range_max = parseInt(value);
            } else {
              questionSelect[questionName].range_max = Infinity;
            }
          });
        }
      }


          
      correctElement.style.display = "none";
      incorrectElement.style.display = "none";
      answerButton.style.display = "none";
          
      answerInputElement.style.display = "none";
      let localData;
      try {
        localData = localStorage.getItem("data");
        if (localData) {
          localData = JSON.parse(localData);
          questionData  = localData.questions;
          sameChars  = localData.sameChars;
          notNextChars  = localData.notNextChars;
          //questionElement.textContent = "";
          questionReadElement.textContent = "";
        }

        let localRecordSession = localStorage.getItem("record_session");
        if (localRecordSession) record_session = JSON.parse(localRecordSession);
        let localRecord = localStorage.getItem("record");
        if (localRecord) record = JSON.parse(localRecord);

        let lastQuestion_before = localStorage.getItem("last_question");
        if (lastQuestion_before) {
          lastQuestion_before = parseInt(lastQuestion_before);
          requestAnimationFrame(() => {
            //questionElement.textContent = questionData[lastQuestion_before][0];
            questionReadElement.textContent = questionData[lastQuestion_before][0];
            document.getElementById("makingQuestionLink").href = url + "?page=makingQuestion&questionIndex=" + questionData[lastQuestion_before][8];
            answer1Element.textContent = questionData[lastQuestion_before][1];
            answer2Element.textContent = questionData[lastQuestion_before][2];
            questionLabelElement.textContent = questionData[lastQuestion_before][5];
          });
        }
      } catch (error) {
        console.error(error);
      }
      let is_loading = true;
      const startLoad = () => requestAnimationFrame(() => {
        document.getElementById("loading").style.display = "";
        is_loading = true;
      });
      const finishLoad = () => requestAnimationFrame(() => {
        document.getElementById("loading").style.display = "none";
        is_loading = false;
      });
      if (localData) {
        nextQuestionButton.addEventListener('click', main_event);
        setQuestionSelect();
        requestGetData(data => {
          questionData  = data.questions;
          sameChars  = data.sameChars;
          notNextChars  = data.notNextChars;
          localStorage.setItem("data", JSON.stringify(data));
          setQuestionSelect();
        });
      } else {
        startElement.disabled = true;
        nextQuestionButton.disabled = true;
        requestGetData(data => {
          questionData  = data.questions;
          sameChars  = data.sameChars;
          notNextChars  = data.notNextChars;
          nextQuestionButton.addEventListener('click', main_event);
          setQuestionSelect();
          //questionElement.textContent = "";
          questionReadElement.textContent = "";
          startElement.disabled = false;
          nextQuestionButton.disabled = false;
          localStorage.setItem("data", JSON.stringify(data));
        }, () => {
          //questionElement.textContent = "データの読み込みに失敗しました。";
          questionElement.textContent = "データの読み込みに失敗しました。";
        });
      }

      stopElement.style.display = "none";
      stopElement.addEventListener('click', event => {
        is_active = false;
        continueProcess = false;
        inputtingAnswer = false;

        answerInputElement.style.display = "none";
        clearInterval(inputIntervalId);

        stopElement.style.display = "none";
        startElement.style.display = "";

        document.body.style.userSelect = "auto";
        document.body.style.webkitUserSelect = "auto";


        if (!is_loading && record.length >= 1) {
          requestSetRecord(record, data => {
            record = [];
            recordLength = 0;
            questionData = data;
            setQuestionSelect();
          })  // 記録を送信
        }

        settingButton.style.display = "";

        if (document.fullscreenElement) document.exitFullscreen();
      });
      startElement.addEventListener('click', event => {
        is_active = true;
        continueProcess = true;
        
        startElement.style.display = "none";
        stopElement.style.display = "";

        document.body.style.userSelect = "";
        document.body.style.webkitUserSelect = "";
        
        settingButton.style.display = "none";

        if (document.getElementById("useFullscreen").checked) document.documentElement.requestFullscreen();
      });
      document.getElementById("answer_input_space").addEventListener('click', event => event.stopPropagation());
      /*answerInputElement.addEventListener('click', event => {
        event.stopPropagation();
        stopElement.dispatchEvent(new Event('click'));
      });*/

      document.getElementById("useSmartphoneMode").addEventListener('change', event => {
        if (document.getElementById("useSmartphoneMode").checked) {
          document.getElementById("answer_input_space").style.maxWidth = "6cm";
          document.getElementById("answer_input").style.fontSize = "15px";
          document.querySelectorAll(".answer_input_buttons button").forEach(element => {
            element.style.fontSize = "27px";
          });
        } else {
          document.getElementById("answer_input_space").style.maxWidth = "";
          document.getElementById("answer_input").style.fontSize = "";
          document.querySelectorAll(".answer_input_buttons button").forEach(element => {
            element.style.fontSize = "";
          });
        }
      });
      document.getElementById("useSmartphoneMode").checked = false;
      /*if (window.matchMedia && window.matchMedia("(any-hover: none)").matches) {
        document.getElementById("useSmartphoneMode").checked = true;
        document.getElementById("useSmartphoneMode").dispatchEvent(new Event('change'));
      }*/

      settingButton.addEventListener("click", event => {
        settingDialog.showModal();
      });
      settingCloseButton.addEventListener("click", event => {
        settingDialog.close();
      });

      document.documentElement.addEventListener('fullscreenchange', event => {
        if (!document.fullscreenElement) {
          const buttonEvent = new Event('click');
          stopElement.dispatchEvent(buttonEvent);
        }
      });

      if(!window.matchMedia('(display-mode: standalone)').matches){
        document.getElementById("makingQuestionLink").target = "_brank";
      }







      async function request(successHandler, failureHandler, method = "GET", body = undefined, parameters = "") {
        if (url && URL.canParse(url)) {
          const urlWithParameters = url + parameters;

          startLoad();
          const response = await fetch(urlWithParameters, {method: method, body: body});
          finishLoad();
          if (!response.ok) {
            if (failureHandler) failureHandler();
            throw new Error(`レスポンスステータス: ${response.status}`);
          }

          const json = await response.json();
          if (successHandler) successHandler(json);
        } else {
          document.getElementById("firstForm").addEventListener("submit", event => {
            url = document.getElementById("API-input").value;
            if (url) localStorage.setItem("quiz-app-URL", url);
            request(successHandler, failureHandler, method, body, parameters);
          }, {once: true});
          document.getElementById("firstDialog").showModal();
        }
      }

      function requestGetData(successHandler = undefined, failureHandler = undefined) {
        request(successHandler, failureHandler);
      }
      function requestSetRecord(record, successHandler = undefined, failureHandler = undefined) {
        request(successHandler, failureHandler, "POST", JSON.stringify({method:"setRecord", parameters:[record]}))
      }
    </script>
    <script src="./script.js"></script>
  </body>
</html>